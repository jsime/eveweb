#!/usr/bin/env perl

use v5.10;
use strict;
use warnings FATAL => 'all';

use Config::Any;
use Data::Dumper;
use DBIx::DataStore ( config => 'yaml' );
use File::Basename;
use Games::EVE::APIv2;

my ($SCRIPT, $BASEDIR) = fileparse(__FILE__);
eval <<EOV;
    use lib '$BASEDIR/../../lib';

    use EVEWeb::Job;
EOV
die "Could not set up environment properly.\n" if $@;

my $cfg = Config::Any->load_files({
    files => ["$BASEDIR/../../eveweb.conf"],
    use_ext => 1,
    flatten_to_hash => 1,
});
$cfg = $cfg->{(keys %{$cfg})[0]};

my $db = DBIx::DataStore->new($cfg->{'Model::DB'}{'datastore'});

JOB:
while (my $job = EVEWeb::Job->claim($db, 'key')) {
    my $res = $db->do(q{
        select k.*
        from eve.api_keys k
        where k.key_id = ?
    }, $job->stash->{'key_id'});

    unless ($res && $res->next) {
        $job->finish;
        $job->save;

        next JOB;
    }

    my $api = Games::EVE::APIv2->new(
        key_id => $res->{'key_id'},
        v_code => $res->{'v_code'},
    );

    if (!$api || $api->key->expired) {
        $job->finish;
        $job->save;

        next JOB;
    }
}
